# dv <- all_visits %>%
#   filter(Date < "2019-03-11" & Date > "2019-01-25") %>%
#   group_by(RFID, Date) %>%
#   summarise(dailyvisits = n())
## mean daily visits per individual
ref <- dv %>%
group_by(RFID) %>%
summarise(mdv = mean(dailyvisits)) %>%
ungroup()
## sd of daily visits
dvsd <- sd(dv$dailyvisits)
## build the df
require(reshape)
mat_ddm <- cast(dv, Date ~ RFID, value = "dailyvisits")
mat_ddm[is.na(mat_ddm)] <- 0
mat <- mat_ddm[2:46]/dvsd
myvec <- (ref$mdv[match(names(mat_ddm[2:45]), ref$RFID)])/dvsd
mat_final <- mat[1] - myvec[1]
for(i in 2:44){
mat_temp <- mat[i] - myvec[i]
mat_final <- cbind(mat_final, mat_temp)
}
mat_final
##
##dowo
dowovisits=mat_final[,which(colnames(mat_final)%in%rownames(dowoadj))]
dowovisits.mat=as.matrix(dowovisits)
dowovisits.mat
dowoadj
dowoadj.norm.row=apply(dowoadj, 1, function(x) x/sum(x, na.rm=T))
dowoadj.norm.row
rowSums(dowoadj.norm.row)
rowSums(dowoadj.norm.row, na.rm=T)
colSums(dowoadj.norm.row, na.rm=T)
dowoadj.norm.row=t(apply(dowoadj, 1, function(x) x/sum(x, na.rm=T)))
rowSums(dowoadj.norm.row, na.rm=T)
dowo.friend.activity=apply(dowoadj.norm.row, 1, function(x) colSums(x*t(dowovisits.mat), na.rm=T))
dowo.friend.activity=as.data.frame(dowo.friend.activity)
dowo.friend.activity
library(lme4)
library(lmerTest)
library(MuMIn)
dowovisits.dat=as.data.frame(dowovisits)
dowovisits.dat$Date=weather.use$Date
dowovisits.dat$nightlows=weather.use$nightlows
dowo.a= dowovisits.dat %>% gather("ID", "z_score", -Date, -nightlows)
dowo.friend.activity$Date=weather.use$Date
dowo.friend.activity$nightlows=weather.use$nightlows
dowo.b = dowo.friend.activity %>% gather("ID", "z_score_friends", -Date, -nightlows)
dowo.final.dat=merge(dowo.a,dowo.b)
dowomod=lmer(z_score~scale(nightlows)*scale(z_score_friends)+(1|ID), data=dowo.final.dat)
summary(dowomod)
r.squaredGLMM(dowomod)
abnuadj.norm.row=t(apply(wbnuadj.trim, 1, function(x) x/sum(x, na.rm=T)))
wbnuvisits=mat_final[,which(colnames(mat_final)%in%rownames(wbnuadj))]
wbnuvisits.mat=as.matrix(wbnuvisits)
wbnuadj.trim=wbnuadj[which(rownames(wbnuadj)%in%colnames(mat_final)),which(rownames(wbnuadj)%in%colnames(mat_final))]
colSums(wbnuadj.trim[1,]*t(wbnuvisits.mat), na.rm=T)
abnuadj.norm.row=t(apply(wbnuadj.trim, 1, function(x) x/sum(x, na.rm=T)))
wbnuadj.norm.row=t(apply(wbnuadj.trim, 1, function(x) x/sum(x, na.rm=T)))
rowSums(wbnuadj.norm.row)
rowSums(wbnuadj.norm.row, na.rm=T)
wbnu.friend.activity=apply(wbnuadj.norm.row, 1, function(x) colSums(x*t(wbnuvisits.mat), na.rm=T))
wbnu.friend.activity=as.data.frame(wbnu.friend.activity)
wbnu.friend.activity
wbnuvisits.dat=as.data.frame(wbnuvisits)
wbnuvisits.dat$Date=weather.use$Date
wbnuvisits.dat$nightlows=weather.use$nightlows
wbnu.a= wbnuvisits.dat %>% gather("ID", "z_score", -Date, -nightlows)
wbnu.friend.activity$Date=weather.use$Date
wbnu.friend.activity$nightlows=weather.use$nightlows
wbnu.b = wbnu.friend.activity %>% gather("ID", "z_score_friends", -Date, -nightlows)
wbnu.final.dat=merge(wbnu.a,wbnu.b)
wbnumod=lmer(z_score~scale(nightlows)*scale(z_score_friends)+(1|ID), data=wbnu.final.dat)
summary(wbnumod)
r.squaredGLMM(wbnumod)
dowomod=lmer(z_score~scale(nightlows)*scale(z_score_friends)+(1|ID), data=dowo.final.dat)
summary(dowomod)
r.squaredGLMM(dowomod)
wbnumod=lmer(z_score~scale(nightlows)*scale(z_score_friends)+(1|ID), data=wbnu.final.dat)
summary(wbnumod)
r.squaredGLMM(wbnumod)
dowomod=lmer(z_score~scale(nightlows)*scale(z_score_friends)+(1|ID), data=dowo.final.dat)
summary(dowomod)
r.squaredGLMM(dowomod)
#### PPNC Network and Temperature Paper
require(tidyverse)
require(lubridate)
##data
load("all_visits.dat")
load("weather.dat")
weather$Date <- as.Date(weather$Date, format = "%m/%d/%Y")
weather <- weather %>%
mutate(Hour = hour(datetime)) %>%
filter(Hour >= 19 | Hour <= 4) %>%
mutate(Lagdate = ifelse(Hour <= 4, paste0(lag(Date)), paste0(Date)))  %>%
group_by(Date) %>%
summarize(nightlows = min(Temp_C)) %>%
ungroup() %>%
mutate(index = as.numeric(Date-min(Date)+1))
demo <- read.csv("RFID_Records_fixed.csv")
demo <- demo %>%
select(-Date) %>%
filter(Species != "SCJU")
## quick stats for results section
ndowo <- all_visits %>%
filter(Species == "DOWO")
nwbnu <- all_visits %>%
filter(Species == "WBNU")
### Species Models for DOWO and WBNU
morn_visits <- all_visits %>%
mutate(Hour = hour(Datetime)) %>%
mutate(Date = date(Datetime)) %>%
filter(Hour >= 6 | Hour <= 11) %>%
group_by(RFID, Date) %>%
summarise(sumvisits = n()) %>%
ungroup() %>%
left_join(weather, by = "Date") %>%
left_join(demo, by = "RFID") %>%
select(Date, RFID, Species, Weight, Tarsus, Wing, Sex, Age, Culmen, nightlows, sumvisits) %>%
filter(Date < "2019-03-11" & Date > "2019-01-25") %>%
filter(Species == "DOWO" | Species == "WBNU")
morn_visits$RFID <- as.factor(morn_visits$RFID)
newdata <- morn_visits[-9]
#write.csv(newdata, file = "C:/Users/Annie Madsen/Documents/Madsen/Coursework/R Class/feederdata.csv")
###
newdat2=newdata %>%  group_by(RFID) %>% mutate(lag1=dplyr::lag(nightlows)) %>% mutate(lead1=dplyr::lead(nightlows))
####
require(mgcv)
md <- gamm(sumvisits ~ s(nightlows, fx = FALSE, bs = "tp") + s(RFID, bs = "re"),
family = poisson,
data = morn_visits %>% filter(Species == "DOWO"))
summary(md$gam)
summary(md$lme)
plot(md$gam)
mw <- gamm(sumvisits ~ s(nightlows, fx = FALSE, bs = "tp") + s(RFID, bs = "re"),
family = poisson,
data = morn_visits %>% filter(Species == "WBNU"))
summary(mw$gam)
summary(mw$lme)
plot(mw$gam)
### species level LMMs
require(lme4)
test_dowo <- glmer(sumvisits ~ scale(nightlows) + (1|RFID), data = morn_visits %>% filter(Species == "DOWO"), family = "poisson")
summary(test_dowo)
test_wbnu <- glmer(sumvisits ~ scale(nightlows) + (1|RFID), data = morn_visits %>% filter(Species == "WBNU"), family = "poisson")
summary(test_wbnu)
anova(test_dowo)
anova(test_wbnu)
Anova(test_wbnu)
require(lmerTest)
summary(test_wbnu)
anova(test_wbnu)
lmerTest::lsmeansLT(test_wbnu)
r.squaredGLMM(test_dowo)
r.squaredGLMM(test_wbnu)
library(rsq)
r.squaredGLMM(test_dowo)
r.squaredGLMM(test_wbnu)
library(MuMIn)
r.squaredGLMM(test_dowo)
r.squaredGLMM(test_wbnu)
plot(resid(test_dowo))
plot(resid(test_wbnu))
plot(sumvisits ~ scale(nightlows), data=morn_visits %>% filter(Species == "DOWO"))
boxplot(sumvisits ~ scale(nightlows), data=morn_visits %>% filter(Species == "DOWO"))
boxplot(sumvisits ~ scale(nightlows), data=morn_visits %>% filter(Species == "WBNU"))
plot(sumvisits ~ scale(nightlows), data=morn_visits %>% filter(Species == "WBNU"))
morn_visits
###outlier?
test_wbnu <- glmer(sumvisits ~ scale(nightlows) + (1|RFID), data = morn_visits %>% filter(Species == "WBNU") %>% filter(RFID !="011016FE79"), family = "poisson")
summary(test_wbnu)
require(tidyverse)
require(lubridate)
##data
load("all_visits.dat")
View(all_visits)
head(all_visits)
wbnu=all_visits %>% filter(Species=="WBNU")
wbnu
wbnu=all_visits %>% filter(Species=="WBNU") %>% split(RFID)
wbnu=all_visits %>% filter(Species=="WBNU") %>% group_by(RFID)
wbnu
wbnu(logger)
wbnu$Logger
wbnu$RFID
wbnu=all_visits %>% filter(Species=="WBNU") %>% arrange(RFID, Logger) %>% group_by(RFID)
wbnu
wbnu$Logger
wbnu=all_visits %>% filter(Species=="WBNU") %>% arrange(RFID, Logger) %>% group_by(RFID)
date(wbnu$Datetime)
wbnu%>% group_by(RFID, date(Datetime)) %>% unique(Logger)
wbnu%>% group_by(RFID, date(Datetime)) %>% n(unique(Logger))
wbnu%>% group_by(RFID, date(Datetime)) %>% distinct(Logger)
wbnu%>% group_by(RFID, date(Datetime)) %>% distinct(Logger) %>% arrange(date(Datetime))
all_visits$Date
wbnu%>% group_by(RFID, Date) %>% distinct(Logger) %>% arrange(Date)
wbnu%>% group_by(RFID, Date) %>% distinct(Logger) %>% arrange(RFID, Date)
wbnu.visits.daily=wbnu%>% group_by(RFID, Date) %>% n()
wbnu.visits.daily=wbnu%>% group_by(RFID, Date) %>% n(RFID)
wbnu.visits.daily=wbnu%>% group_by(RFID, Date) %>% count()
wbnu.visits.daily
wbnu.visits.daily.feeders=wbnu%>% group_by(RFID, Date) %>% count(unique(Logger))
wbnu.visits.daily.feeders=wbnu%>% group_by(RFID, Date) %>% count(distinct(Logger))
wbnu.visits.daily.feeders=wbnu%>% group_by(RFID, Date) %>% n_distinct(Logger)
wbnu%>% group_by(RFID, Date)
## This time with single-species networks
library(asnipe)
library(igraph)
library(tidyverse)
library(lubridate)
#import files
gmmDOWO=readRDS("conspecificDOWOflocks.rds") #import gmm results file. Will need this for permuting group-by-individual matrices.
gmmWBNU=readRDS("conspecificWBNUflocks.rds") #import gmm results file. Will need this for permuting group-by-individual matrices.
gbi_dowo=gmmDOWO$gbi
gbi_wbnu=gmmWBNU$gbi
dowoadj=get_network(gbi_dowo)
wbnuadj=get_network(gbi_wbnu)
diag(dowoadj)=NA
diag(wbnuadj)=NA
###
load("all_visits.dat")
load("weather.dat")
demo=read.csv("RFID_Records_fixed.csv")
all_visits
weather$Date <- as.Date(weather$Date, format = "%m/%d/%Y")
weather.use <- weather %>%
mutate(Hour = hour(datetime)) %>%
filter(Hour >= 19 | Hour <= 4) %>%
mutate(Lagdate = ifelse(Hour <= 4, paste0(lag(Date)), paste0(Date))) %>%
group_by(Date) %>%
summarize(nightlows = min(Temp_C)) %>%
ungroup() %>%
filter(Date>"2019-01-26"&Date<"2019-03-10")
#weather
morn_visits <- all_visits %>%
mutate(Hour = hour(Datetime)) %>%
mutate(Date = date(Datetime)) %>%
filter(Hour >= 6 | Hour <= 11) %>%
group_by(RFID, Date) %>%
summarise(sumvisits = n()) %>%
ungroup() %>%
left_join(weather, by = "Date") %>%
filter(Date < "2019-03-11" & Date > "2019-01-25")
morn_visits$RFID <- as.factor(morn_visits$RFID)
#shortcut
morn_visits$dailyvisits=morn_visits$sumvisits
dv=morn_visits
## daily visits per individual
# dv <- all_visits %>%
#   filter(Date < "2019-03-11" & Date > "2019-01-25") %>%
#   group_by(RFID, Date) %>%
#   summarise(dailyvisits = n())
## mean daily visits per individual
ref <- dv %>%
group_by(RFID) %>%
summarise(mdv = mean(dailyvisits)) %>%
ungroup()
## sd of daily visits
dvsd <- sd(dv$dailyvisits)
## build the df
require(reshape)
mat_ddm <- cast(dv, Date ~ RFID, value = "dailyvisits")
mat_ddm[is.na(mat_ddm)] <- 0
mat <- mat_ddm[2:46]/dvsd
myvec <- (ref$mdv[match(names(mat_ddm[2:45]), ref$RFID)])/dvsd
mat_final <- mat[1] - myvec[1]
for(i in 2:44){
mat_temp <- mat[i] - myvec[i]
mat_final <- cbind(mat_final, mat_temp)
}
mat_final
##
##dowo
dowovisits=mat_final[,which(colnames(mat_final)%in%rownames(dowoadj))]
dowovisits.mat=as.matrix(dowovisits)
dowoadj.bin=dowoadj
dowoadj.bin[which(dowoadj.bin>0)]=1
colSums(dowoadj.bin[1,]*t(dowovisits.mat), na.rm=T)
dowoadj.norm.row=t(apply(dowoadj, 1, function(x) x/sum(x, na.rm=T)))
dowo.friend.activity=apply(dowoadj.norm.row, 1, function(x) colSums(x*t(dowovisits.mat), na.rm=T))
dowo.friend.activity=as.data.frame(dowo.friend.activity)
dowo.friend.activity
library(lme4)
library(lmerTest)
library(MuMIn)
dowovisits.dat=as.data.frame(dowovisits)
dowovisits.dat$Date=weather.use$Date
dowovisits.dat$nightlows=weather.use$nightlows
dowo.a= dowovisits.dat %>% gather("ID", "z_score", -Date, -nightlows)
dowo.friend.activity$Date=weather.use$Date
dowo.friend.activity$nightlows=weather.use$nightlows
dowo.b = dowo.friend.activity %>% gather("ID", "z_score_friends", -Date, -nightlows)
dowo.final.dat=merge(dowo.a,dowo.b)
dowomod=lmer(z_score~scale(nightlows)*scale(z_score_friends)+(1|ID), data=dowo.final.dat)
summary(dowomod)
r.squaredGLMM(dowomod)
#### PPNC Network and Temperature Paper
require(tidyverse)
require(lubridate)
##data
load("C:/Users/Annie Madsen/Documents/Madsen/R/all_visits.dat")
load("C:/Users/Annie Madsen/Documents/Madsen/R/weather.dat")
weather$Date <- as.Date(weather$Date, format = "%m/%d/%Y")
weather <- weather %>%
mutate(Hour = hour(datetime)) %>%
filter(Hour >= 19 | Hour <= 4) %>%
mutate(Lagdate = ifelse(Hour <= 4, paste0(lag(Date)), paste0(Date)))  %>%
group_by(Date) %>%
summarize(nightlows = min(Temp_C)) %>%
ungroup() %>%
mutate(index = as.numeric(Date-min(Date)+1))
demo <- read.csv("C:/Users/Annie Madsen/Documents/Madsen/Pioneers Park Project/Bird Banding Data/RFID_Records_03052019.csv")
demo <- demo %>%
select(-Date) %>%
filter(Species != "SCJU")
# ## quick stats for results section
# ndowo <- all_visits %>%
#   filter(Species == "DOWO")
# nwbnu <- all_visits %>%
#   filter(Species == "WBNU")
### Species Models for DOWO and WBNU
morn_visits <- all_visits %>%
mutate(Hour = hour(Datetime)) %>%
mutate(Date = date(Datetime)) %>%
filter(Hour >= 6 | Hour <= 11) %>%
group_by(RFID, Date) %>%
summarise(sumvisits = n()) %>%
ungroup() %>%
left_join(weather, by = "Date") %>%
left_join(demo, by = "RFID") %>%
select(Date, RFID, Species, Weight, Tarsus, Wing, Sex, Age, Culmen, nightlows, sumvisits) %>%
filter(Date < "2019-03-11" & Date > "2019-01-25") %>%
filter(Species == "DOWO" | Species == "WBNU")
morn_visits$RFID <- as.factor(morn_visits$RFID)
# newdata <- morn_visits[-9]
# write.csv(newdata, file = "C:/Users/Annie Madsen/Documents/Madsen/Coursework/R Class/feederdata.csv")
require(mgcv)
md <- gamm(sumvisits ~ s(nightlows, fx = FALSE, bs = "tp") + s(RFID, bs = "re"),
family = poisson,
data = morn_visits %>% filter(Species == "DOWO"))
summary(md$gam)
summary(md$lme)
plot(md$gam)
family = poisson,
data = morn_visits %>% filter(Species == "WBNU"))
summary(mw$gam)
summary(mw$lme)
plot(mw$gam)
### species level LMMs
require(lme4)
test_dowo <- glmer(sumvisits ~ scale(nightlows) + (1|RFID), data = morn_visits %>% filter(Species == "DOWO"), family = "poisson")
plot(resid(test))
test_wbnu <- glmer(sumvisits ~ scale(nightlows) + (1|RFID), data = morn_visits %>% filter(Species == "WBNU"), family = "poisson")
plot(resid(test))
library(rsq)
library(MuMIn)
library(arm)
r.squaredGLMM(test_dowo)
r.squaredGLMM(test_wbnu)
### generating exploratory tendency metrics for Kris Hans UCARE project
require(tidyverse)
require(lubridate)
##data
load("all_visits.dat")
head(all_visits)
all_visits$Date
wbnu=all_visits %>% filter(Species=="WBNU") %>% arrange(RFID, Logger)
wbnu.visits.daily=wbnu%>% group_by(RFID, Date) %>% count()
wbnu.visits.daily.feeders=wbnu%>% group_by(RFID, Date) %>% n_distinct(Logger)
wbnu.visits.daily
wbnu%>% group_by(RFID, Date)
n_distinct(Logger)
n_distinct(wbnu$Logger)
wbnu.visits.daily.feeders=wbnu%>% group_by(RFID, Date) %>% summarise(n_distinct(Logger))
wbnu.visits.daily.feeders
wbnu%>% group_by(RFID, Date) %>% count()
wbnu%>% group_by(RFID, Date)
wbnu%>% group_by(RFID, Date) %>% select(RFID, Date, Logger)
wbnu%>% group_by(RFID, Date)
wbnu.visits.daily.feeders=wbnu%>% group_by(RFID, Date) %>% select(RFID, Date, Logger) %>% summarise(n_distinct(Logger))
wbnu.visits.daily.feeders
wbnu%>% group_by(RFID, Date) %>% select(RFID, Date, Logger)
wbnu%>% group_by(RFID, Date) %>% select(RFID, Date, Logger) %>% table()
wbnu%>% group_by(RFID, Date) %>% select(RFID, Logger, Date) %>% table()
logger_array=wbnu%>% group_by(RFID, Date) %>% select(RFID, Logger, Date) %>% table()
class(logger_array)
logger_array=wbnu%>% group_by(RFID, Date) %>% select(Logger, RFID,  Date) %>% table()
logger_array
logger_array=wbnu%>% group_by(RFID, Date) %>% select(Logger,  Date,RFID) %>% table()
logger_array
apply(logger_array, c(2,3), sum)
wbnu.visits.daily
apply(logger_array, c(2,3), sum)
indiv_date_sum=apply(logger_array, c(2,3), sum)
indiv_avg_visit=colMeans(indiv_date_sum)
indiv_avg_visit
indiv_date_sum
write.csv(indiv_date_sum, "visits_indiv_x_date.csv")
logger_array
apply(logger_array, 3, colSums)
apply(logger_array, 3, function(x) x/colSums(x))
apply(logger_array, 3, function(x) x/rowSums(x))
apply(logger_array, 3, function(x) x/colSums(x))
logger_array
apply(logger_array, 3, function(x) x/colSums(x))
apply(logger_array, 3, function(x) {
p=x/colSums(x)
ln_p=log(p)
sum(p*ln_p)}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0){
p=x/colSums(x)
ln_p=log(p)
sum(p*ln_p)
}}
)
warnings()
apply(logger_array, 3, function(x) colSums(x) >0)
apply(logger_array, 3, function(x) {
if(colSums(x)>0){
p=x/colSums(x)
}
ln_p=log(p)
sum(p*ln_p)}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0) p=x/colSums(x) else next
ln_p=log(p)
sum(p*ln_p)}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0) {p=x/colSums(x)}
ln_p=log(p)
sum(p*ln_p)}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0) {p=x/colSums(x)}
#ln_p=log(p)
#sum(p*ln_p)}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0) {p=x/colSums(x)}
#ln_p=log(p)
#sum(p*ln_p)
}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0) {p=x/colSums(x)}
ln_p=log(p)
sum(p*ln_p, na.rm=T)
}
)
apply(logger_array, 3, function(x) {
if(colSums(x)>0) p=x/colSums(x)
ln_p=log(p)
sum(p*ln_p, na.rm=T)
}
)
apply(logger_array, 3, function(x) {
p=x/colSums(x)
ln_p=log(p)
sum(p*ln_p, na.rm=T)
}
)
p
apply(logger_array, 3, function(x) {
p=x/colSums(x)
#ln_p=log(p)
#sum(p*ln_p, na.rm=T)
}
p
)
apply(logger_array, 3, function(x) {
p=x/colSums(x)
#ln_p=log(p)
#sum(p*ln_p, na.rm=T)
}
p
)
apply(logger_array, 3, function(x) {
p=x/colSums(x)}
#ln_p=log(p)
#sum(p*ln_p, na.rm=T)}
p
)
apply(logger_array, 3, function(x) {
p=x/colSums(x)}
p
#ln_p=log(p)
#sum(p*ln_p, na.rm=T)}
)
apply(logger_array, 3, function(x) {
p=x/colSums(x)
p})
apply(logger_array, 3, function(x) {
if (colSums(x)==0) p=NA else {
p=x/colSums(x)
p}})
apply(logger_array, 3, function(x) {
if (colSums(x)==0) p=NA else p=x/colSums(x)
})
p
apply(logger_array, 3, function(x) {
if (colSums(x)==0) p=NA else p=x/colSums(x)
p
})
logger_array
head(all_visits)
unique(all_visits$RFID)
write.csv(unique(all_visits$RFID), "RFID_indivs.csv")
